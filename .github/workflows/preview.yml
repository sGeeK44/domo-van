name: Preview

on:
  workflow_dispatch:

jobs:
  # =============================================================================
  # TEST JOBS - Run in parallel
  # =============================================================================

  test-mobile:
    uses: ./.github/workflows/_test-mobile.yml

  test-water:
    uses: ./.github/workflows/_test-esp32.yml
    with:
      module: water-module

  test-heater:
    uses: ./.github/workflows/_test-esp32.yml
    with:
      module: heater-module

  # =============================================================================
  # BUILD JOBS - Run after tests pass (in parallel with each other)
  # =============================================================================

  build-mobile:
    needs: test-mobile
    uses: ./.github/workflows/_build-mobile.yml
    with:
      profile: preview
      message: Preview build
    secrets:
      EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}

  build-water:
    needs: test-water
    uses: ./.github/workflows/_build-esp32.yml
    with:
      module: water-module
      version: preview

  build-heater:
    needs: test-heater
    uses: ./.github/workflows/_build-esp32.yml
    with:
      module: heater-module
      version: preview
